---
title: "Quantile Regression"
author: "Chris Cioffi, Kristina Frazier, Aidan Hennessy, Mike McHenry"
format: revealjs
editor: visual
embed-resources: true
---

## Quantile Regression

-   A useful alternative to Ordinary Least Squares (OLS).

-   Produces estimated regression coefficients for specific quantiles of the response variable.

    -   As a result, the coefficients will change as the specified quantile of the response variable changes.

## Sample Density

```{r}
# Load libraries
library(tidyverse)
library(quantreg)

set.seed(17)
# Generate random normal data
df_rnd <- as.tibble(rnorm(10000))

df_rnd |>
  ggplot(aes(value)) +
  geom_density() +
  geom_vline(xintercept = quantile(df_rnd$value, prob = 0.25), color = "red") +
  geom_vline(xintercept = quantile(df_rnd$value, prob = 0.50), color = "black") +
  geom_vline(xintercept = quantile(df_rnd$value, prob = 0.99), color = "blue") +
  labs(title = "Sample Density Plot",
       x = "",
       y = "") +
  theme_bw()
```

## Example of Linear and Quantile Trend Lines

```{r}
set.seed(16)
eps <- rnorm(100,0,2)
df_trends <- tibble(x = rnorm(100), y = 1.5*x + eps)

df_trends |>
  ggplot(aes(x, y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  stat_quantile(quantiles = 0.15, color = "red", linetype = "dashed") +
  stat_quantile(quantiles = 0.85, color = "red", linetype = "dashed") +
  annotate(geom="text", x=2.1, y=2.5, label="Linear\nregression", color = "blue", size = 3.5) +
  annotate(geom="text", x=2.1, y=7, label="Quantile\nregression\nat 0.85", color = "red", size = 3.5) +
  annotate(geom="text", x=2.1, y=-1, label="Quantile\nregression\n at 0.15", color = "red", size = 3.5) +
  theme_bw()
```

## Why Use Quantile Regression?

-   The relationship between the predictor and response variables may vary across the distribution, making it useful to allow the estimates to change.

    -   A richer description of the relationship.

-   More robust to outliers.

-   If OLS assumptions are violated.

    -   Nonconstant variance, nonnormality, independence, nonlinearity.

## General Form of the Model

-   $Q_\tau(Y) = \beta_0(\tau) + \beta_1(\tau)X_1 + ... + \beta_p(\tau)X_p$

-   Where $\tau$ is a specific quantile value.

-   The objective of quantile regression is to minimize the median absolute deviations (Quantile Loss).

    -   Rather than minimizing the sum of squares in OLS.

## Differences in Minimization

-   OLS: $\sum_{i}^{N}(e_i)^2$

-   Quantile: $\sum_{e_i < 0} \tau |e_i| + \sum_{e_i > 0}(1-\tau) |e_i|$

    -   $\tau |e_i|$ penalizes underprediction and $(1 - \tau) |e_i|$ penalizes overprediction

## Model Assumptions

-   Large sample size.

-   Response variable is continuous without a grouping of observations at one particular value.

-   No strict distribution to adhere to.

## Quantreg

-   While the lm() function allows us to use linear regression and estimate the conditional mean of the response, considering explanatory variable values, quantreg can be used to easily conduct quantile regression in R.

## Quantreg and WHO data

-   Demo: estimate the conditional quantiles, considering the predictors, and here we can use quantreg to compare world nations' life expectancies to its so-called income index.

-   The dataset is maintained by the World Health Organization and looks at a variety of public health and income factors for world nations. We're using a Kaggle version, which can be easily downloaded [here](https://gist.github.com/aishwarya8615/89d9f36fc014dea62487f7347864d16a).

-   \*Demo adapted from examples found on Medium and R-bloggers

## Quantreg and WHO data

-   After removing nations with incomplete information, we can see a positive relationship between developed countries and higher life expectancy.

```{r}
#import data 
life_exp_narm <- read_csv("Life_Expectancy_Data.csv")
#let's remove all with income index around 0 and just pull in the life expectancy and income score columns for the purposes of this exercise.
life_exp_narm <- life_exp_narm |> 
  filter(Income_composition_of_resources>0) |>
  select(Income_composition_of_resources, Life_expectancy,Status)

#summary statistics for the 

#plot the data 
ggplot(life_exp_narm, aes(x=Income_composition_of_resources, 
                          y=Life_expectancy, col=Status)) + geom_point() +
  xlab("Income index") + ylab("Life expectancy") +
  theme_bw()
```

## Quantile regression vs Linear Regression

-   While linear regression can give us the mean value, quantreg can allow us to find any quantile ranging from the 1st percentile to the 99th percentile. We can also easily evaluate the 50th percentile (the median) which can be more resistant to outliers than linear regression's mean.

## Quantile regression vs Linear Regression

```{r}

ggplot(life_exp_narm, aes(x=Income_composition_of_resources, 
                          y=Life_expectancy, col=Status)) + geom_point() +
  geom_smooth(method = lm, se = FALSE, color = "red", size = 1) + # linear model
  geom_quantile(color = "blue", quantiles = 0.5, size=1) + # median quantile regression model with tau = 0.5 -- 50%
  labs(title = "Life expectancy ~ income index - lm mean (red), quantreg median (blue)", y = "Life Expectancy", x = "Income Index") +
  theme_bw()
```

## Quantreg for quantiles

-   In addition to comparing the mean to the median, we can also look at the top and bottom quantiles to compare the confidence intervals for life expectancies. First run the different models

```{r}
notrqfit<- lm(Life_expectancy ~ Income_composition_of_resources, data = life_exp_narm)
rqfit25 <- rq(Life_expectancy ~ Income_composition_of_resources, tau = 0.25, data = life_exp_narm)
rqfit50 <- rq(Life_expectancy ~ Income_composition_of_resources, tau = 0.50, data = life_exp_narm)
rqfit75 <- rq(Life_expectancy ~ Income_composition_of_resources, tau = 0.75, data = life_exp_narm)
rqfit99 <- rq(Life_expectancy ~ Income_composition_of_resources, tau = 0.99, data = life_exp_narm)
```

## Comparing the mean and median

-   When comparing the confidence intervals using the median quantile regression and linear regression for the mean, the values roughty align.

```{r}
summary(life_exp_narm)
#data pulled from the 1q, median and 3q results from original data
new_data<-data.frame(Income_composition_of_resources=c(.525,0.695,0.793))
#comparing the median and mean 
predict(notrqfit, newdata=new_data,  interval="confidence", level=.9) 
predict(rqfit50, newdata=new_data, interval="confidence", level=.9) 

```

## 1st Quartile vs 3rd Quartile

-   Using the same income scores from the previous slide, we can see that life expectancies are different depending on the quantile of life expectancy. Comparing the 25th quantile to the 75th quantile and the 99th quantile, it's easy to see how different the life expectancy for those people would be depending on their income. Additionallly, the wealth of an individual's country plays a factor in life expectancy, regardless of their personal income.

## 1st Quartile vs 3rd Quartile Prediction Results

-   The first set of results is using the quantile regression at the 25th quantile, the second uses the 75th quantile, and the 3rd uses the 99th quantile.

```{r}
predict(rqfit25, newdata=new_data, interval="confidence", level=.9) 
predict(rqfit75, newdata=new_data, interval="confidence", level=.9) 
#even more extreme in the 99percentile
predict(rqfit99, newdata=new_data, interval="confidence", level=.9) 

```

## Progression of the Coefficients

```{r}
myrq <- rq(Life_expectancy ~ Income_composition_of_resources, tau = c(0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90), data = life_exp_narm)
plot(summary(myrq), parm = "Income_composition_of_resources")
```

## Next Steps

-   Revise example

-   Add more to background of quantile regression

## References

https://www.voxco.com/blog/quantile-regression/

https://drkebede.medium.com/quantile-regression-tutorial-in-r-f2eec72c132b

https://www.r-bloggers.com/2019/01/quantile-regression-in-r-2/

https://www.sfu.ca/\~dsignori/buec333/lecture%208.pdf

https://www.aptech.com/blog/the-basics-of-quantile-regression/
